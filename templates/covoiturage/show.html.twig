{% extends 'base.html.twig' %}

{% block title %}Détails du covoiturage de
	{{ covoiturage.lieuDepart }}
	à
	{{ covoiturage.lieuArrivee }}
{% endblock %}

{% block body %}
	<div class="container my-5">
		<div class="row">
			{# ============================================= #}
			{# COLONNE PRINCIPALE : DÉTAILS DU TRAJET        #}
			{# ============================================= #}
				<div class="col-lg-7"> <div class="card shadow-sm mb-4">
					<div class="card-header bg-primary text-white">
						<h1 class="h3 mb-0 d-flex align-items-center">
							<i class="bi bi-geo-alt-fill me-2"></i>
							{{ covoiturage.lieuDepart }}
							<i class="bi bi-arrow-right mx-3"></i>
							{{ covoiturage.lieuArrivee }}
						</h1>
					</div>
					<div class="card-body">
						<div class="row g-3">
							<div class="col-md-6">
								<h5>
									<i class="bi bi-calendar-event me-2"></i>Départ</h5>
								<p class="mb-0">{{ covoiturage.dateDepart|date('l d F Y') }}
									à
									<strong>{{ covoiturage.heureDepart }}</strong>
								</p>
							</div>
							<div class="col-md-6">
								<h5>
									<i class="bi bi-calendar-check me-2"></i>Arrivée estimée</h5>
								<p class="mb-0">{{ covoiturage.dateArrivee ? covoiturage.dateArrivee|date('l d F Y') ~ ' à ' ~ covoiturage.heureArrivee : 'Non spécifiée' }}</p>
							</div>
						</div>

						<hr>

						{% if covoiturage.description %}
							<h5 class="mt-4">
								<i class="bi bi-info-circle me-2"></i>Détails du trajet</h5>
							<p class="text-muted">{{ covoiturage.description|nl2br }}</p>
						{% endif %}
						{% if app.user and covoiturage.chauffeur == app.user %}
							<div class="mb-4">
								{% if covoiturage.statut == 'en_attente' %}
									<form method="post" action="{{ path('app_covoiturage_start', {'id': covoiturage.id}) }}">
										<input type="hidden" name="_token" value="{{ csrf_token('start' ~ covoiturage.id) }}">
										<button class="btn btn-success">Démarrer le covoiturage</button>
									</form>
									<form method="post" action="{{ path('app_covoiturage_cancel', {'id': covoiturage.id}) }}" class="d-inline ms-2" onsubmit="return confirm('Annuler ce covoiturage ?');">
										<input type="hidden" name="_token" value="{{ csrf_token('cancel' ~ covoiturage.id) }}">
										<button class="btn btn-danger">Annuler</button>
									</form>
								{% elseif covoiturage.statut == 'en_cours' %}
									<form method="post" action="{{ path('app_covoiturage_end', {'id': covoiturage.id}) }}">
										<input type="hidden" name="_token" value="{{ csrf_token('end' ~ covoiturage.id) }}">
										<button class="btn btn-primary">Terminer le covoiturage</button>
									</form>
								{% elseif covoiturage.statut == 'termine' %}
									<span class="badge bg-success">Trajet terminé</span>
								{% elseif covoiturage.statut == 'annule' %}
									<span class="badge bg-danger">Trajet annulé</span>
								{% endif %}
							</div>
						{% endif %}

						<h5 class="mt-4">
							<i class="bi bi-car-front-fill me-2"></i>Véhicule</h5>
						<p class="mb-0">
							<strong>{{ covoiturage.voiture.marque.libelle }}
								{{ covoiturage.voiture.modele }}</strong>
							- Couleur
							{{ covoiturage.voiture.couleur }}
						</p>
					</div>
				</div>
			</div>

			{# ============================================= #}
			{# COLONNE LATÉRALE : RÉSERVATION & CHAUFFEUR    #}
			{# ============================================= #}
				<div class="col-lg-5"> <div
					class="sticky-top" style="top: 20px;">
					{# --- Carte de Réservation --- #}
					<div class="card shadow-sm mb-4">
						<div class="card-body text-center">
							<h5 class="card-title">Réserver votre place</h5>
							<h3 class="text-success fw-bold my-3">{{ covoiturage.prixPersonne|number_format(2, ',', ' ') }}
								€
								<small class="text-muted">/ personne</small>
							</h3>
							<p class="text-info fw-bold">{{ covoiturage.nbPlaceRestantes }}
								place{{ covoiturage.nbPlaceRestantes > 1 ? 's' : '' }}
								restante{{ covoiturage.nbPlaceRestantes > 1 ? 's' : '' }}
								sur
								{{ covoiturage.nbPlaceTotal }}</p>
							<div class="d-grid">
								{% if app.user %}
									{% if covoiturage.chauffeur == app.user %}
										<p class="alert alert-info small m-0">C'est votre trajet. Vous pouvez le
											<a href="{{ path('app_covoiturage_edit', {'id': covoiturage.id}) }}">modifier</a>.</p>
									{% else %}
										{% set hasReserved = false %}
										{% for reservation in covoiturage.reservations %}
											{% if reservation.passager == app.user %}
												{% set hasReserved = true %}
											{% endif %}
										{% endfor %}

										{% if hasReserved %}
											<p class="alert alert-success m-0">Vous avez déjà réservé.</p>
										{% elseif covoiturage.nbPlaceRestantes > 0 %}
											<form method="post" action="{{ path('app_covoiturage_reserver', {'id': covoiturage.id}) }}" onsubmit="return confirm('Confirmez-vous la réservation pour ce trajet ?');" class="m-0">
												<input type="hidden" name="_token" value="{{ csrf_token('reserver' ~ covoiturage.id) }}">
												<button class="btn btn-success btn-lg w-100">Réserver ma place</button>
											</form>
										{% else %}
											<button class="btn btn-warning btn-lg w-100" disabled>Complet</button>
										{% endif %}
									{% endif %}
								{% else %}
									<a href="{{ path('app_login', {'redirect_to': app.request.pathInfo}) }}" class="btn btn-primary btn-lg w-100">Se connecter pour réserver</a>
								{% endif %}
							</div>
						</div>
					</div>

					{# --- Carte du Chauffeur --- #}
					{% set chauffeur = covoiturage.chauffeur %}
					<div class="card shadow-sm mb-4">
						<div class="card-header">
							<h5 class="mb-0">Proposé par</h5>
						</div>
						<div class="card-body text-center">
							<a href="{{ path('app_public_profile_show', {'id': chauffeur.id}) }}" class="text-decoration-none text-dark">
								<img src="{{ asset(chauffeur.avatarUrl) }}" alt="Avatar de {{ chauffeur.pseudo }}" class="rounded-circle mb-3" width="100" height="100">
								<h5 class="card-title">{{ chauffeur.pseudo }}</h5>
							</a>
							<p class="card-text text-muted">
								Membre
								{{ chauffeur.membershipDurationAsString }}
							</p>
							<div class="d-flex justify-content-center align-items-center">
								<span class="fw-bold fs-5 me-2">{{ chauffeur.averageRating|number_format(1, ',', ' ') }}</span>
								<span class="text-warning">
									{% for i in 1..5 %}
										{% if i <= chauffeur.averageRating %}
											<i class="bi bi-star-fill"></i>
										{% elseif i - 0.5 <= chauffeur.averageRating %}
											<i class="bi bi-star-half"></i>
										{% else %}
											<i class="bi bi-star"></i>
										{% endif %}
									{% endfor %}
								</span>
								<span class="text-muted ms-2">({{ chauffeur.avisRecus|length }}
									avis)</span>
							</div>
						</div>
					</div>

					{# --- Carte des Avis --- #}
					{% set avisRecus = chauffeur.avisRecus|sort((a, b) => b.dateCreation <=> a.dateCreation) %}
					<div class="card shadow-sm">
						<div class="card-header">
							<h5 class="mb-0">Derniers avis</h5>
						</div>
						<div class="card-body">
							{% if avisRecus is not empty %}
								<ul class="list-unstyled mb-0">
									{% for avis in avisRecus|slice(0, 3) %}
										{% include 'avis/_avis_item.html.twig' with {'avis': avis} %}
									{% endfor %}
								</ul>
								{% if avisRecus|length > 3 %}
									<div class="text-center mt-3">
										<a href="{{ path('app_public_profile_show', {'id': chauffeur.id}) }}" class="btn btn-outline-primary btn-sm">Voir tous les avis</a>
									</div>
								{% endif %}
							{% else %}
								<p class="text-muted mb-0">
									<i class="bi bi-chat-square-text me-2"></i>
									{{ chauffeur.pseudo }}
									n'a pas encore reçu d'avis.
								</p>
							{% endif %}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
{% endblock %}
