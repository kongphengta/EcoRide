{% extends 'base.html.twig' %}
{% block title %}Espace Administrateur
{% endblock %}
{% block body %}
	<h1>Espace Administrateur</h1>

	<a href="{{ path('admin_create_employe') }}" class="btn btn-primary mb-3">Créer un employé</a>
	<h2>Utilisateurs</h2>
	<table class="table">
		<thead>
			<tr>
				<th>Email</th>
				<th>Rôles</th>
				<th>Statut</th>
				<th>Action</th>
			</tr>
		</thead>
		<tbody>
			{% for user in users %}
				<tr>
					<td>{{ user.email }}</td>
					<td>{{ user.roles|join(', ') }}</td>
					<td>
						{% if user.isActive %}
							<span class="badge bg-success">Actif</span>
						{% else %}
							<span class="badge bg-danger">Suspendu</span>
						{% endif %}
					</td>
					<td>
						{% if user.isActive %}
							<a href="{{ path('admin_suspend_user', {'id': user.id}) }}" class="btn btn-warning btn-sm">Suspendre</a>
						{% else %}
							<a href="{{ path('admin_activate_user', {'id': user.id}) }}" class="btn btn-success btn-sm">Réactiver</a>
						{% endif %}
						<a href="#" class="btn btn-info btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#editRoleModal" data-user-id="{{ user.id }}" data-user-email="{{ user.email }}" data-user-roles="{{ user.roles|join(',') }}">Modifier le rôle</a>
					</td>
				</tr>
			{% endfor %}
		</tbody>
	</table>

	<h2>Nombre de covoiturages par jour</h2>
	<canvas id="covoituragesChart" width="400" height="150"></canvas>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	<script>
		const ctx = document.getElementById('covoituragesChart').getContext('2d');
new Chart(ctx, {
type: 'bar',
data: {
labels: {{ jours|json_encode|raw }},
datasets: [
{
label: 'Covoiturages',
data: {{ totaux|json_encode|raw }},
backgroundColor: 'rgba(54, 162, 235, 0.5)',
borderColor: 'rgba(54, 162, 235, 1)',
borderWidth: 1
}
]
},
options: {
scales: {
y: {
beginAtZero: true
}
}
}
});
	</script>

	<h2>Crédits gagnés par jour</h2>
	<h3 class="mt-4">Total des crédits gagnés :
		<span class="badge bg-success">{{ totalCredits }}</span>
	</h3>
	<canvas id="creditsChart" width="400" height="150"></canvas>
	<script>
		const ctx2 = document.getElementById('creditsChart').getContext('2d');
new Chart(ctx2, {
type: 'line',
data: {
labels: {{ joursCredits|json_encode|raw }},
datasets: [
{
label: 'Crédits gagnés',
data: {{ creditsParJour|json_encode|raw }},
backgroundColor: 'rgba(255, 206, 86, 0.2)',
borderColor: 'rgba(255, 206, 86, 1)',
borderWidth: 2,
fill: true
}
]
},
options: {
scales: {
y: {
beginAtZero: true
}
}
}
});
	</script>
	<!-- Modal Modification de rôle -->
	<div class="modal fade" id="editRoleModal" tabindex="-1" aria-labelledby="editRoleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<form method="post" action="{{ path('admin_edit_role') }}">
					<div class="modal-header">
						<h5 class="modal-title" id="editRoleModalLabel">Modifier le rôle de l'utilisateur</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>
					<div class="modal-body">
						<input type="hidden" name="user_id" id="modal-user-id">
						<div class="mb-3">
							<label for="modal-user-email" class="form-label">Email</label>
							<input type="text" class="form-control" id="modal-user-email" readonly>
						</div>
						<div class="mb-3">
							<label for="modal-user-role" class="form-label">Rôle</label>
							<select class="form-select" name="role" id="modal-user-role">
								<option value="ROLE_USER">Passager</option>
								<option value="ROLE_CHAUFFEUR">Chauffeur</option>
								<option value="ROLE_ADMIN">Admin</option>
							</select>
						</div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
						<button type="submit" class="btn btn-primary">Enregistrer</button>
					</div>
				</form>
			</div>
		</div>
	</div>

	<script>
		var editRoleModal = document.getElementById('editRoleModal');
editRoleModal.addEventListener('show.bs.modal', function (event) {
var button = event.relatedTarget;
var userId = button.getAttribute('data-user-id');
var userEmail = button.getAttribute('data-user-email');
var userRoles = button.getAttribute('data-user-roles');
document.getElementById('modal-user-id').value = userId;
document.getElementById('modal-user-email').value = userEmail;
// Sélectionne le rôle principal
var roleSelect = document.getElementById('modal-user-role');
if (userRoles.includes('ROLE_ADMIN')) {
roleSelect.value = 'ROLE_ADMIN';
} else if (userRoles.includes('ROLE_CHAUFFEUR')) {
roleSelect.value = 'ROLE_CHAUFFEUR';
} else {
roleSelect.value = 'ROLE_USER';
}
});
	</script>
{% endblock %}
